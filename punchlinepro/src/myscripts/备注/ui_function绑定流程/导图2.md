
æˆ‘æ¥è¯¦ç»†è®²è§£å¯¼å‡ºå­—å¹•(ç´«è‰²æŒ‰é’®)çš„å®Œæ•´è§¦å‘æµç¨‹é€»è¾‘ï¼Œå¹¶æ‰¾å‡ºå…·ä½“çš„ä»£ç ä½ç½®ã€‚

Read file: src/contentScript.js
è®©æˆ‘ç»§ç»­æŸ¥çœ‹æ›´å¤šçš„ä»£ç ä»¥æ‰¾åˆ°æ¶ˆæ¯ç›‘å¬å™¨ï¼š

Read file: src/contentScript.js
æˆ‘ç°åœ¨éœ€è¦æ£€æŸ¥å…³äºå¯¼å‡ºå­—å¹•çš„æ¶ˆæ¯å¤„ç†ï¼Œè®©æˆ‘çœ‹çœ‹å†…å®¹è„šæœ¬ä¸­çš„æ¶ˆæ¯ç›‘å¬å™¨éƒ¨åˆ†ä»¥åŠå­—å¹•ç›¸å…³æ–‡ä»¶ï¼š

Read file: src/contentScript.js
è®©æˆ‘ä»¬æŸ¥çœ‹subtitle.jsä»¥åŠyoutube.jsæ–‡ä»¶ï¼Œçœ‹çœ‹å¯¼å‡ºåŠŸèƒ½æ˜¯å¦‚ä½•å®ç°çš„ï¼š

Read file: src/subtitle/subtitle.js

Read file: src/subtitle/youtube.js
ç°åœ¨è®©æˆ‘æŸ¥çœ‹BaseVideoä¸­æ˜¯å¦ä¹Ÿæœ‰ç›¸å…³çš„å¯¼å‡ºåŠŸèƒ½ï¼š

Ran tool
ç°åœ¨æˆ‘ä»¬æ‰¾åˆ°äº†ç›¸å…³ä»£ç ï¼Œè®©æˆ‘è¯¦ç»†è§£é‡Šå¯¼å‡ºå­—å¹•(ç´«è‰²æŒ‰é’®)çš„å®Œæ•´è§¦å‘æµç¨‹é€»è¾‘ï¼š

### å¯¼å‡ºå­—å¹•(ç´«è‰²æŒ‰é’®)çš„å®Œæ•´è§¦å‘æµç¨‹

#### 1. æŒ‰é’®å®šä¹‰ä¸åˆå§‹é…ç½®
- åœ¨`src/pages/index.vue`æ–‡ä»¶ä¸­ï¼Œå®šä¹‰äº†å¯¼å‡ºå­—å¹•æŒ‰é’®ï¼š
```javascript
exportSubtitle: {
  description: browser.i18n.getMessage("Export_Subtitle"),
  optionType: "button",
  action: "exportSubtitle"
}
```
- è¯¥æŒ‰é’®è¢«æ·»åŠ åˆ°`advancedTabData`å¯¹è±¡ä¸­ï¼Œä½œä¸ºé«˜çº§è®¾ç½®é€‰é¡¹ä¹‹ä¸€

#### 2. UIæ¸²æŸ“ä¸äº‹ä»¶ç»‘å®š
- è¯¥æŒ‰é’®ä½¿ç”¨Vueç»„ä»¶`v-btn`æ¸²æŸ“ï¼Œè®¾ç½®äº†ä¸»è‰²è°ƒï¼ˆç´«è‰²ï¼‰ï¼š
```html
<v-btn
  v-else-if="option.optionType == 'button'"
  block
  color="primary"
  @click="handleOptionAction(option.action)"
>
  {{ option.description }}
</v-btn>
```
- å½“ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œè§¦å‘`handleOptionAction('exportSubtitle')`æ–¹æ³•

#### 3. æ¶ˆæ¯ä¼ é€’ - ä»å¼¹å‡ºçª—å£åˆ°å†…å®¹è„šæœ¬
- åœ¨`src/pages/index.vue`çš„`handleOptionAction`æ–¹æ³•ä¸­å¤„ç†æŒ‰é’®ç‚¹å‡»ï¼š
```javascript
async handleOptionAction(action) {
  if (action === "exportSubtitle") {
    // è·å–å½“å‰æ´»åŠ¨æ ‡ç­¾é¡µ
    const [tab] = await browser.tabs.query({ active: true, currentWindow: true });
    if (tab) {
      // å‘å½“å‰æ ‡ç­¾é¡µå‘é€æ¶ˆæ¯
      browser.tabs.sendMessage(tab.id, { action: "exportSubtitle" });
    }
  }
}
```

#### 4. å†…å®¹è„šæœ¬æ¥æ”¶æ¶ˆæ¯å¹¶å¤„ç†
- åœ¨`src/contentScript.js`çš„æœ«å°¾å®šä¹‰äº†æ¶ˆæ¯ç›‘å¬å™¨ï¼š
```javascript
browser.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.action === "exportSubtitle") {
    for (var key in subtitle) {
      if (subtitle[key].sitePattern.test(window.location.href)) {
        subtitle[key].exportSubtitle();
        break;
      }
    }
  }
});
```
- è¿™ä¸ªç›‘å¬å™¨æ¥æ”¶æ¥è‡ªæ‰©å±•å…¶ä»–éƒ¨åˆ†çš„æ¶ˆæ¯ï¼Œå½“æ¥æ”¶åˆ°`exportSubtitle`åŠ¨ä½œæ—¶ï¼š
    - éå†æ‰€æœ‰æ”¯æŒçš„å­—å¹•å¤„ç†å™¨ï¼ˆYouTubeã€Netflixç­‰ï¼‰
    - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æµ‹è¯•å½“å‰URLæ˜¯å¦åŒ¹é…è¯¥å¤„ç†å™¨
    - å¦‚æœåŒ¹é…ï¼Œè°ƒç”¨è¯¥å¤„ç†å™¨çš„`exportSubtitle`æ–¹æ³•

#### 5. YouTubeå­—å¹•å¯¼å‡ºå®ç°
- åœ¨`src/subtitle/youtube.js`ä¸­ï¼Œå®ç°äº†`exportSubtitle`æ–¹æ³•ï¼š
```javascript
static async exportSubtitle() {
  try {
    // å°è¯•è·å–è§†é¢‘ä¸Šçš„æ‰€æœ‰å¯ç”¨å­—å¹•è½¨é“
    const playerApi = this.getPlayerApi();
    if (!playerApi) throw new Error('æ— æ³•è·å–æ’­æ”¾å™¨API');
    
    // è·å–å­—å¹•åˆ—è¡¨
    const captionList = playerApi.getOption('captions', 'tracklist');
    if (!captionList || captionList.length === 0) {
      console.error('âŒ æœªæ‰¾åˆ°å¯ç”¨å­—å¹•');
      return;
    }
    console.log('ğŸ” æ‰¾åˆ°å¯ç”¨çš„å­—å¹•:', captionList);

    // è·å–å½“å‰è§†é¢‘æ ‡é¢˜
    const videoTitle = document.querySelector('h1.ytd-video-primary-info-renderer')?.textContent?.trim() || 'video';
    
    // ä¸‹è½½æ‰€æœ‰å¯ç”¨çš„å­—å¹•
    for (const caption of captionList) {
      // ... å­—å¹•å¤„ç†é€»è¾‘ ...
      
      // è·å–SRTæ ¼å¼å­—å¹•
      const response = await fetch(this.getTrafficSafeUrl(caption.baseUrl + '&fmt=json3'));
      const subtitleData = await response.json();
      
      // å°†å­—å¹•æ•°æ®è½¬æ¢ä¸ºæ˜“è¯»çš„æ–‡æœ¬æ ¼å¼
      // ... æ ¼å¼è½¬æ¢é€»è¾‘ ...
      
      // åˆ›å»ºBlobå¹¶ä¸‹è½½
      const blob = new Blob([subtitleText], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  } catch (error) {
    console.error('âŒ å¯¼å‡ºå­—å¹•æ—¶å‘ç”Ÿé”™è¯¯:', error);
  }
}
```

è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦åŠŸèƒ½ï¼š
- è·å–YouTubeæ’­æ”¾å™¨API
- è·å–æ‰€æœ‰å¯ç”¨çš„å­—å¹•è½¨é“
- è·å–è§†é¢‘æ ‡é¢˜ä½œä¸ºæ–‡ä»¶åçš„ä¸€éƒ¨åˆ†
- éå†æ¯ä¸ªå­—å¹•è½¨é“ï¼š
    - ä»YouTube APIè·å–å­—å¹•æ•°æ®
    - å°†æ•°æ®è½¬æ¢ä¸ºæ˜“è¯»çš„æ–‡æœ¬æ ¼å¼ï¼ˆåŒ…å«æ—¶é—´æˆ³ï¼‰
    - åˆ›å»ºBlobå¯¹è±¡å¹¶è§¦å‘ä¸‹è½½
    - æ¯ä¸ªå­—å¹•è½¨é“ç”Ÿæˆä¸€ä¸ªå•ç‹¬çš„æ–‡æœ¬æ–‡ä»¶ï¼Œæ–‡ä»¶ååŒ…å«è§†é¢‘æ ‡é¢˜å’Œè¯­è¨€ä»£ç 

#### è¾…åŠ©å·¥å…·æ–¹æ³•
- `formatTime` - å°†æ¯«ç§’è½¬æ¢ä¸ºæ—¶:åˆ†:ç§’.æ¯«ç§’æ ¼å¼
- `getTrafficSafeUrl` - å¤„ç†URLä»¥é¿å…æµé‡é—®é¢˜

### æ€»ç»“
ç´«è‰²æŒ‰é’®çš„å¯¼å‡ºå­—å¹•åŠŸèƒ½è§¦å‘æµç¨‹æ˜¯ä¸€ä¸ªå…¸å‹çš„æµè§ˆå™¨æ‰©å±•æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼Œä»ç”¨æˆ·ç•Œé¢åˆ°å†…å®¹è„šæœ¬çš„æ•°æ®æµå¦‚ä¸‹ï¼š

1. ç”¨æˆ·ç‚¹å‡»å¯¼å‡ºæŒ‰é’® â†’
2. å¼¹å‡ºçª—å£çš„Vueç»„ä»¶è§¦å‘äº‹ä»¶å¤„ç† â†’
3. è·å–å½“å‰æ´»åŠ¨æ ‡ç­¾å¹¶å‘é€æ¶ˆæ¯ â†’
4. å†…å®¹è„šæœ¬æ¥æ”¶æ¶ˆæ¯å¹¶ç¡®å®šæ­£ç¡®çš„å­—å¹•å¤„ç†å™¨ â†’
5. YouTubeå¤„ç†å™¨è·å–æ‰€æœ‰å¯ç”¨å­—å¹•å¹¶ä¸‹è½½

è¿™ç§è®¾è®¡å…è®¸æ‰©å±•ç¨‹åºåœ¨ä¸åŒçš„ç½‘ç«™ä¸Šå·¥ä½œï¼Œæ¯ä¸ªç½‘ç«™æœ‰è‡ªå·±çš„å­—å¹•å¤„ç†é€»è¾‘ï¼Œä½†é€šè¿‡ç»Ÿä¸€çš„æ¶ˆæ¯æ¥å£è¿›è¡Œäº¤äº’ã€‚
